<!DOCTYPE HTML>
<html>
    <head>
    <meta charset="UTF-8">
    <title>Лабораторна робота №5, Ведмидь Святослав, ПК-15-1</title>
    <style>
    h1,h2,h3 {text-align:center}
    XMP {color:darkblue}
    P {text-align:justify}
    </style>
    </head>
    <body>
    <h2>Лабораторная работа №5. Программирование в C. Работа с динамическими библиотеками.</h1>
    <h3>Задание лабораторной работы</h3>
    <p> Создайте отдельный файл на языке C. Запишите в нем функцию, которая принимает
        два параметра. Скомпилируйте динамическую библиотеку с расширением <code>so</code>.
        Создайте основную программу, которая будет вызывать данную функцию.
        Использовать статическую и динамическую загрузку библиотеки. </p>
        <h3>Код</h3>
        <p>C-файл динамической библиотеки sum.c</p>
        <xmp>
            int Sum(int a, int b) {
                return a + b;
            }
        </xmp>
        <p>Header-файл динамической библиотеки sum.h</p>
        <xmp>
            int Sum(int a, int b);
        </xmp>
        <p>Файл с главной функцией main.c (статическая загрузка библиотеки)</p>
        <xmp>
            #include <stdio.h>
            #include "sum.h"
            int main() {
                printf("Sum(5,-3) = %i\n",Sum(5,-3));
                return 0;
            }
        </xmp>
        <p>Файл с главной функцией main_dynamic.c (динамическая загрузка библиотеки)</p>
        <xmp>
            #include <dlfcn.h>
            #include <stdio.h>
            int main() {
                void *handle = dlopen("libsum.so",RTLD_LAZY);
                if(!handle) {
                    printf("%s\n",dlerror());
                    return 1;
                }
                int(*Sum)(int,int) = dlsym(handle,"Sum");
                if(dlerror() != NULL) {
                    printf("%s\n",dlerror());
                    return 1;
                }
                printf("Sum(10,7) = %i\n",(*Sum)(10,7));
                dlclose(handle);
                return 0;
            }                        
        </xmp>
    <h3>Пояснения</h3>
    <p>
        Для создания динамической библиотеки используем команду
        <code>gcc -shared -o libsum.so -fPIC sum.c sum.h</code>
        , где<br>
        <code>-fPIC</code> - использовать относительную адресацию в
        переходах подпрограмм - во избежание конфликтов при         
        динамическом связывании;<br>
        <code>-shared</code> - предписывает создать динамическую
        (т.е. "разделяемую") библиотеку.
    </p>
    <p>
        Для использования библиотеки со статической загрузкой требуется подключить
        файл с объявлением функции sum (т.е. подключаем файл sum.h).
        Далее просто вызываем функцию.<br>
        Для компиляции файла main.c с библиотекой используем команду
        <code>gcc main.c -L/home/vladislav/ -lsum -Wl,-rpath,/home/vladislav/</code>, где<br>
        <code>-Wl,-rpath,/home/vladislav/</code> - обращение к линковщику,<br>
        <code>-rpath</code> - опция линковщика,<br>
        <code>/home/vladislav/</code> - значение опции.  Т.е. этим мы указываем
        линковщику абсолютный адрес, и программа в данной системе будет запускаться из любого каталога.
        <br>После этого запускаем на исполнение полученный файл <code>/home/vladislav/a.out</code> .
    </p>
    <p>
        Для использования библиотеки с динамической загрузкой требуется командой
        <code>dlopen</code> загрузить в память динамическую библиотеку,
        командой <code>dlsym</code> получить адрес функции из библиотеки,
        и командой <code>dlclose</code> закрыть доступ к библиотеке по окончанию использования.<br>
        Для компиляции файла main_dynamic.c с библиотекой используем команду
        <code>gcc main.c -ldl -L/home/vladislav/ -lsum -Wl,-rpath,/home/vladislav/</code>, где<br>
        <code>-ldl</code> означает компоновку с библиотекой libdl.
    </p>
	</body>
    </html>